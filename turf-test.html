<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>turf-polygon</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src="https://code.jquery.com/jquery-3.3.1.min.js"
integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
crossorigin="anonymous"></script>
<script src='js/turf.min.js'></script>
<script src='https://api.tiles.mapbox.com/mapbox.js/v2.0.1/mapbox.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/v2.0.1/mapbox.css' rel='stylesheet' />

<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
</style>
</head>
<body>
<div id='map'></div>

<script>
L.mapbox.accessToken = 'pk.eyJ1IjoiZ2NzYWx6YnVyZyIsImEiOiJjam1pNm5uZmcwMXNyM3FtNGp6dTY3MGxsIn0.PmLPkI3T8UxjEIPnz7fxEA';

var map = L.mapbox.map('map', 'jvrousseau.h4h90e5o').setView([47.414591, 13.388446], 7);

initMap();

function initMap() {
    var items = {};
    $.getJSON( "http://sfws.lfrz.at/json.php",{command: "getstations"}).done(function(data){
        $.each( data, function( key, val ) {
            items[key] = {
                "n": val.n,
                "x": val.x,
                "y": val.y,
                "lat":((-0.00767*val.y)+49.00947),  // Magic numbers!
                "lng":((0.011317*val.x)+9.516872),
                "val":0.0
            };
        });
        $.getJSON( "http://sfws.lfrz.at/json.php",{command: "getdata"}).done(function(data){
            $.each( data.values, function( key, val ) {
                items[key].val = val.v;
            });
            set_heatmap(items);
        });
    });

    function set_heatmap(items){

        var heatMapData = [];

        $.each(items, function(k,v){
            var loc = turf.point([v.lng, v.lat], {radiation: v.val});
            heatMapData.push(loc);
        });

        var collection = turf.featureCollection(heatMapData);
        collection.features.forEach(function(feat) {
            var lat = feat.geometry.coordinates[1];
            var lng = feat.geometry.coordinates[0];
            L.circle([lat,lng], feat.properties.radiation*100, {stroke: false, fillOpacity: 0.7, color: '#0000ff'}).addTo(map);
        });

        var geojsonMarkerOptions = {
            radius: 4,
            fillColor: "#000",
            color: "#000",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
        };

        L.geoJson(collection, {
            pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, geojsonMarkerOptions);
            }
        }).addTo(map);

        var voronoiPolygons = turf.voronoi(collection);
        L.geoJson(voronoiPolygons,{
            style: function(feature){
                var opts = {fillOpacity:0, weight:2, color:'#ff0000'};
                return opts;
                }
            }).addTo(map);
        console.log(voronoiPolygons);
        }
    };
</script>
</body>
</html>